<ng-template #dialogContent>
  <div class="modal-header bg-info">
    <h4 class="modal-title" i18n>Record Editor: {{recordLabel}}</h4>
    <button type="button" class="close" 
      i18n-aria-label aria-label="Close" 
      (click)="dismiss('cross_click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form #fmEditForm="ngForm" role="form" class="form-validated common-form striped-odd">
      <div class="form-group row" *ngFor="let field of fields">
        <div class="col-lg-3 offset-lg-1">
          <label for="{{idPrefix}}-{{field.name}}">{{field.label}}</label>
        </div>
        <div class="col-lg-7">

          <span *ngIf="field.template">
            <ng-container
              *ngTemplateOutlet="field.template; context:customTemplateFieldContext(field)">
            </ng-container> 
          </span>

          <span *ngIf="!field.template">

            <span *ngIf="field.datatype == 'id' && !pkeyIsEditable">
              {{record[field.name]()}}
            </span>
  
            <ng-container *ngIf="field.datatype == 'id' && pkeyIsEditable">
              <ng-container *ngIf="field.readOnly">
                <span>{{record[field.name]()}}</span>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">
                <input
                  class="form-control"
                  name="{{field.name}}"
                  id="{{idPrefix}}-{{field.name}}"
                  placeholder="{{field.label}}..."
                  i18n-placeholder
                  [required]="field.isRequired()"
                  [ngModel]="record[field.name]()"
                  (ngModelChange)="record[field.name]($event)"/>
              </ng-container>
            </ng-container>
  
            <ng-container 
              *ngIf="field.datatype == 'text' || field.datatype == 'interval'">
              <ng-container *ngIf="field.readOnly">
                <span>{{record[field.name]()}}</span>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">
                <input
                  class="form-control"
                  name="{{field.name}}"
                  id="{{idPrefix}}-{{field.name}}"
                  placeholder="{{field.label}}..."
                  i18n-placeholder
                  [required]="field.isRequired()"
                  [ngModel]="record[field.name]()"
                  (ngModelChange)="record[field.name]($event)"/>
              </ng-container>
            </ng-container>

            <!-- TODO: add support to eg-date-select for read-only view -->
            <span *ngIf="field.datatype == 'timestamp'">
              <eg-date-select
                domId="{{idPrefix}}-{{field.name}}"
                (onChangeAsIso)="record[field.name]($event)"
                initialIso="{{record[field.name]()}}">
              </eg-date-select>
            </span>

            <ng-container *ngIf="field.datatype == 'int'">
              <ng-container *ngIf="field.readOnly">
                <span>{{record[field.name]()}}</span>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">

              <input
                class="form-control"
                type="number"
                name="{{field.name}}"
                id="{{idPrefix}}-{{field.name}}"
                placeholder="{{field.label}}..."
                i18n-placeholder
                [required]="field.isRequired()"
                [ngModel]="record[field.name]()"
                (ngModelChange)="record[field.name]($event)"/>
              </ng-container>
            </ng-container>

            <ng-container *ngIf="field.datatype == 'float'">
              <ng-container *ngIf="field.readOnly">
                <span>{{record[field.name]()}}</span>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">
                <input
                  class="form-control"
                  type="number" step="0.1"
                  name="{{field.name}}"
                  id="{{idPrefix}}-{{field.name}}"
                  placeholder="{{field.label}}..."
                  i18n-placeholder
                  [required]="field.isRequired()"
                  [ngModel]="record[field.name]()"
                  (ngModelChange)="record[field.name]($event)"/>
              </ng-container>
            </ng-container>
      
            <ng-container *ngIf="field.datatype == 'money'">
              <ng-container *ngIf="field.readOnly">
                <span>{{record[field.name]() | currency}}</span>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">
                <input
                  class="form-control"
                  type="number" step="0.1"
                  name="{{field.name}}"
                  id="{{idPrefix}}-{{field.name}}"
                  placeholder="{{field.label}}..."
                  i18n-placeholder
                  [readonly]="field.readOnly"
                  [required]="field.isRequired()"
                  [ngModel]="record[field.name]()"
                  (ngModelChange)="record[field.name]($event)"/>
              </ng-container>
            </ng-container>
  
            <input *ngIf="field.datatype == 'bool'"
              class="form-check-input"
              type="checkbox"
              name="{{field.name}}"
              id="{{idPrefix}}-{{field.name}}"
              [disabled]="field.readOnly"
              [ngModel]="record[field.name]()"
              (ngModelChange)="record[field.name]($event)"/>
  
            <ng-container *ngIf="field.datatype == 'link'">
              <ng-container *ngIf="field.readOnly">
                <!-- in readOnly mode, if a value is present, it will
                    live as the only item in the linkedValues array -->
                <ng-container *ngIf="(field.linkedValues != null) && (field.linkedValues.length)">
                  <span>{{field.linkedValues[0].name}}</span>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="!field.readOnly">
                <span [ngClass]="{nullable : !field.isRequired()}">
                  <select
                    class="form-control"
                    name="{{field.name}}"
                    id="{{idPrefix}}-{{field.name}}"
                    [required]="field.isRequired()"
                    [ngModel]="record[field.name]()"
                    (ngModelChange)="record[field.name]($event)">
                    <option *ngFor="let item of field.linkedValues" 
                      [value]="item.id">{{item.name}}</option>
                  </select>
                </span>
              </ng-container>
            </ng-container>
  
            <eg-org-select *ngIf="field.datatype == 'org_unit'"
              placeholder="{{field.label}}..."
              i18n-placeholder
              domId="{{idPrefix}}-{{field.name}}"
              [limitPerms]="modePerms[mode]"
              [readOnly]="field.readOnly"
              [applyDefault]="field.orgDefaultAllowed"
              [initialOrgId]="record[field.name]()"
              (onChange)="record[field.name]($event)">
            </eg-org-select>

          </span>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-success" *ngIf="mode == 'view'"
      (click)="close()" i18n>Close</button>
    <button type="button" class="btn btn-info" 
      [disabled]="fmEditForm.invalid" *ngIf="mode != 'view'"
      (click)="save()" i18n>Save</button>
    <button type="button" class="btn btn-warning ml-2" *ngIf="mode != 'view'"
      (click)="cancel()" i18n>Cancel</button>
  </div>
</ng-template>
